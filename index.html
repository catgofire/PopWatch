<!DOCTYPE html>
<html>
<head>
  <title>pop stocks ticker data</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js" type="text/javascript"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.10/jquery-ui.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="flot/jquery.flot.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="flot/jquery.flot.selection.js" type="text/javascript" charset="utf-8"></script>
  <script type="text/javascript" charset="utf-8">
    // var ticker_url = "http://pop-stocks.appspot.com/api/market/getTickerStocks";
    var ticker_url = "getTickerStocks.php";
    var plot_options = {
      legend: {
        noColumns: 10,
        margin: [30, 5],
        selection: { mode: "x" },
      },
    };
    
    displayTickerStocks = function(ticker_data)
    {
      console.log("Ticker Data");
      console.log(ticker_data);

      var bar_data = [];
      var series = [];
      for(var i in ticker_data)
      {
        // bar_data.push([parseInt(i), ticker_data[i].marketPrice]);
        bar_data.push([ticker_data[i].marketPrice, ticker_data[i].displayName, ticker_data[i].lastNightlyPrice]);
      }
      
      sort_data = function(a, b){ return (a[0] - b[0]);}
      bar_data.sort(sort_data);
      
      for(var i in bar_data)
      {
        i = parseInt(i);
        var tmp = bar_data[i];
        var went_up = (tmp[0] - tmp[2]) >= 0 ? true : false;
        var point_fill_color = went_up ? 'rgb(0,255,0)' : 'rgb(255,0,0)';
        
        series.push({
          data: [[i, tmp[0]]],
          bars: {show: true, barWidth: 0.8, fill: 1.0, align: "center"},
          label: tmp[1],
          hoverable: true,
        });
        series.push({
          data: [[(i), tmp[2]]],
          points: {show: true, fill: 1.0, fillColor: point_fill_color},
          color: point_fill_color,
        });
      }

      var plot = $.plot($("#placeholder"), series, plot_options);
      
      // setup overview
      var overview = $.plot($("#overview"), series, {
          legend: { show: true, container: $("#overviewLegend") },
          series: {
              lines: { show: true, lineWidth: 1 },
              shadowSize: 0
          },
          xaxis: { ticks: 4 },
          yaxis: { ticks: 3 },
          grid: { color: "#999" },
          selection: { mode: "x" }
      });
      
      $("#placeholder").bind("plotselected", function (event, ranges) {
          // clamp the zooming to prevent eternal zoom
          if (ranges.xaxis.to - ranges.xaxis.from < 0.00001)
              ranges.xaxis.to = ranges.xaxis.from + 0.00001;
          if (ranges.yaxis.to - ranges.yaxis.from < 0.00001)
              ranges.yaxis.to = ranges.yaxis.from + 0.00001;

          // do the zooming
          plot = $.plot($("#placeholder"), getData(ranges.xaxis.from, ranges.xaxis.to),
                        $.extend(true, {}, options, {
                            xaxis: { min: ranges.xaxis.from, max: ranges.xaxis.to },
                            yaxis: { min: ranges.yaxis.from, max: ranges.yaxis.to }
                        }));

          // don't fire event on the overview to prevent eternal loop
          overview.setSelection(ranges, true);
      });
      $("#overview").bind("plotselected", function (event, ranges) {
          plot.setSelection(ranges);
      });
      
      
    }
    
    getTickerStocks = function()
    {
      $.getJSON(ticker_url, displayTickerStocks);
    }
  </script>
</head>
<body>
  <div style="float:left">
    <div id="placeholder" style="width:900px;height:600px"></div>
  </div>
  
  <div id="miniature" style="float:left;margin-left:20px">
    <div id="overview" style="width:166px;height:100px"></div>

    <p id="overviewLegend" style="margin-left:10px"></p>
  </div>
  
  <!-- <div id="placeholder" style="width:900px;height:600px"></div>   -->
  
  <div style="clear:both">
    <input type="button" onclick="getTickerStocks();" value="Get Ticker Stocks">
  </div>
  
  
</body>
</html>

